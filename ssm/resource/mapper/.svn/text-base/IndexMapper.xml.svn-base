<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="richinfo.mm.monitor.web.dao.IndexMapper">

	<resultMap id="pageminutefaultstatResultMap" type="richinfo.mm.monitor.web.enties.PageMinuteFaultStat">
		<!-- <id column="id" property="id" jdbcType="INTEGER" /> -->
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="createtime" property="createtime" jdbcType="DATE" />
		<result column="faultno" property="faultno" jdbcType="INTEGER" />
		<result column="ehs" property="error_hits" jdbcType="INTEGER" />
		<result column="name" property="faultname" jdbcType="INTEGER" />
		
		<!-- <result column="traffic" property="traffic" jdbcType="INTEGER" /> -->
	</resultMap>
	<resultMap id="pageminutestatResultMap" type="richinfo.mm.monitor.web.enties.PageMinuteStat">
		<!-- <id column="id" property="id" jdbcType="INTEGER" /> -->
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="req_nums" property="req_nums" jdbcType="INTEGER" />
		<result column="traffic_up" property="traffic" jdbcType="INTEGER" />
		<result column="traffic_dn" property="traffic2" jdbcType="INTEGER" />
		<result column="createtime" property="createtime" jdbcType="DATE" />
		<result column="createtime2" property="createtime2" jdbcType="TIME" />
	</resultMap>
	<resultMap id="pagedetailsResultMap" type="richinfo.mm.monitor.web.enties.PageDetails">
		<!-- <id column="id" property="id" jdbcType="INTEGER" /> -->
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="resp_time_avg" property="resp_time_avg" jdbcType="INTEGER" />
		<result column="phone_groupbycount" property="phone_groupbycount" jdbcType="INTEGER" />
		<result column="successrate" property="successrate" jdbcType="INTEGER" />		
		<result column="createtime" property="createtime" jdbcType="DATE" />
		<result column="createtime2" property="createtime2" jdbcType="TIME" />
		<result column="top3province" property="top3province" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="pagedetailsResultMap2" type="richinfo.mm.monitor.web.enties.PageDetails">
		<result column="resp_time_avgall" property="resp_time_avgall" jdbcType="INTEGER" />
		<result column="successrate_all" property="successrate_all" jdbcType="INTEGER" />
		<result column="phone_all" property="phone_all" jdbcType="INTEGER" />
	</resultMap>
	<!-- <sql id="Base_Column_List">
		id, url, menu, parent, layer, ord, target,
		createtime,codeName
	</sql> -->
	<select id="selectflows" resultMap="pageminutestatResultMap" parameterType="java.util.HashMap">
		select id,traffic_up,traffic_dn,createtime,createtime as createtime2 from page_minute_fault_stat where 
		<![CDATA[
		unix_timestamp(createtime) >= #{starttime} and unix_timestamp(createtime) < #{endtime}
		 ]]>
	</select>
	<select id="selectnowreq" resultMap="pageminutestatResultMap" parameterType="java.util.HashMap">
		select id,traffic_up,traffic_dn,req_nums,createtime,createtime as createtime2 from page_minute_stat where 
		<![CDATA[
		unix_timestamp(createtime) >= #{starttime} and unix_timestamp(createtime) < #{endtime}
		 ]]>
	</select>
	<select id="selecterrors" resultMap="pageminutefaultstatResultMap" parameterType="java.util.HashMap">
		<![CDATA[
		select mfs.id,mfs.createtime,mfs.faultno,sum(mfs.error_hits) as ehs,ft.name from page_minute_fault_stat mfs left join fault_type ft on ft.id=mfs.faultno where 
		unix_timestamp(mfs.createtime) >= #{starttime} and unix_timestamp(mfs.createtime) < #{endtime} 
		group by mfs.faultno order by ehs desc
		 ]]>
	</select>
	<select id="selecttimemap" resultMap="pagedetailsResultMap" parameterType="java.util.HashMap">
		<![CDATA[
		select pd.province,avg(pd.resp_time) as resp_time_avg,  (1-sum(pd.ERROR_HITS)/sum(pd.HITS))*100 as successrate,
			count(distinct pd.phone) as phone_groupbycount, pd.createtime as createtime, pd.createtime as createtime2 ,pd.province as top3province
			from page_details as pd
		where unix_timestamp(pd.createtime) >= #{starttime} and unix_timestamp(pd.createtime) < #{endtime} 
		group by pd.province order by phone_groupbycount desc
		 ]]>
	</select>
	<select id="selecttimemap2" resultMap="pagedetailsResultMap2" parameterType="java.util.HashMap">
		<![CDATA[
		select avg(tem1.resp_time_avg) as resp_time_avgall,avg(tem1.successrate) as successrate_all, sum(tem1.phone_groupbycount) as phone_all from 
		(select pd.province,avg(pd.resp_time) as resp_time_avg,sum(pd.ERROR_HITS),sum(pd.HITS),  (1-sum(pd.ERROR_HITS)/sum(pd.HITS))*100 as successrate,
			count(distinct pd.phone) as phone_groupbycount from page_details as pd
		where unix_timestamp(pd.createtime) >= #{starttime} and unix_timestamp(pd.createtime) < #{endtime} 
		group by pd.province order by phone_groupbycount desc) as tem1
		 ]]>
	</select>

<!-- <select id="selectnowreq" resultMap="pageminutestatResultMap">
		select id,req_nums,createtime,createtime as createtime2 from page_minute_fault_stat where 
		<![CDATA[
		unix_timestamp(createtime) >= unix_timestamp(now()) -3600 and unix_timestamp(createtime) < unix_timestamp(now())
		 ]]>
	</select> -->
</mapper>